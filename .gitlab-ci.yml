image: golang:1.10

stages:
  - test

variables:
  NAMESPACE_SRC_DIR: "${GOPATH}/src/gitlab.com/${CI_PROJECT_NAMESPACE}"

before_script:
  # Ensure a symlink to this project directory exists within GOPATH
  - mkdir -p "${NAMESPACE_SRC_DIR}"
  - ln -s "${CI_PROJECT_DIR}" "${NAMESPACE_SRC_DIR}/${CI_PROJECT_NAME}"
  #- mkdir -p ${GOPATH}/src/gitlab.com/${CI_PROJECT_NAMESPACE}
  #- cd ${GOPATH}/src/gitlab.com/${CI_PROJECT_NAMESPACE}
  #- ln -s ${CI_PROJECT_DIR}
  # install go dependencies
  # discordgo develop branch
  - >
    (
      go get -v github.com/bwmarrin/discordgo
      && cd ${GOPATH}/src/github.com/bwmarrin/discordgo
      && git checkout develop
    )
  # all other dependencies
  - go get -v ./...
  # install linters
  - >
    go get -v
    golang.org/x/tools/cmd/goimports
    gopkg.in/alecthomas/gometalinter.v2
  - gometalinter.v2 --install

Go Tests:
  stage: test
  script:
    - diff <(goimports -d .) <(echo -n)
    - go test -v -race $(go list ./... | grep -v /vendor/)
    - gometalinter.v2 --deadline 60m --concurrency=2 --vendor --exclude=^vendor\/ ./...
  retry: 1
